# Git Workflow & Deployment

## Branch Strategy

```
main        → Production (Vercel Production + Production Supabase)
develop     → Staging (Vercel Preview + Test Supabase)
feature/*   → Feature branches (local development)
```

## Environments

| Branch | Vercel | Supabase | URL |
|--------|--------|----------|-----|
| `main` | Production | **Production DB** | geo-analyser-web.vercel.app |
| `develop` | Preview | **Test DB** | geo-analyser-web-git-develop-*.vercel.app |
| `feature/*` | Preview | **Test DB** | (auto-generated) |

⚠️ **IMPORTANT**: Production DB contains real user data. Never test with production!

---

## Agent Commands

### "Nasaď na dev" / "Deploy to dev"

When user says to deploy to dev/staging:

```bash
# 1. Run tests (MUST pass)
npm run test:run

# 2. Build check (MUST pass)
npm run build

# 3. Commit changes
git add .
git commit -m "feat/fix/chore: description of changes"

# 4. Push to develop
git checkout develop
git merge main  # or merge feature branch
git push origin develop
```

**Vercel automatically deploys** preview from `develop` branch.

### "Nasaď na produkci" / "Deploy to production"

When user says to deploy to production:

```bash
# 1. Ensure on develop branch with latest changes
git checkout develop
git pull origin develop

# 2. Run tests (MUST pass)
npm run test:run

# 3. Build check (MUST pass)  
npm run build

# 4. Merge to main
git checkout main
git pull origin main
git merge develop

# 5. Push to production
git push origin main

# 6. Update CHANGELOG.md with new version
```

**Vercel automatically deploys** production from `main` branch.

---

## Pre-Deployment Checklist

### Before ANY deployment:

- [ ] `npm run test:run` passes (all tests green)
- [ ] `npm run build` passes (no build errors)
- [ ] No TypeScript errors
- [ ] Tested manually in browser
- [ ] No console errors

### Before PRODUCTION deployment:

- [ ] All above checks pass
- [ ] Tested on dev/preview environment first
- [ ] Database migrations applied (if any)
- [ ] CHANGELOG.md updated
- [ ] User confirmed deployment

---

## Commit Message Format

```
type: short description

Types:
- feat:     New feature
- fix:      Bug fix
- chore:    Maintenance, dependencies
- docs:     Documentation
- style:    UI/styling changes
- refactor: Code refactoring
- test:     Adding tests
```

Examples:
```
feat: add project duplication feature
fix: resolve credit calculation rounding error
chore: update dependencies
docs: add testing documentation
```

---

## Vercel Environment Variables

### Production (main branch)
```
NEXT_PUBLIC_SUPABASE_URL=https://[prod-project].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[prod-anon-key]
SUPABASE_SERVICE_ROLE_KEY=[prod-service-key]
```

### Preview (all other branches)
```
NEXT_PUBLIC_SUPABASE_URL=https://[test-project].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[test-anon-key]
SUPABASE_SERVICE_ROLE_KEY=[test-service-key]
```

**Setup in Vercel:**
1. Go to Project Settings → Environment Variables
2. For each variable, set different values for "Production" vs "Preview"

---

## Rollback Procedure

If production deployment breaks:

```bash
# Option 1: Revert in Vercel Dashboard
# Go to Deployments → Find last working → Promote to Production

# Option 2: Git revert
git checkout main
git revert HEAD
git push origin main
```

---

## Database Migrations

When schema changes are needed:

1. Write migration SQL in `supabase/migrations/XXXX_description.sql`
2. **Test on Test Supabase first**
3. Deploy code to develop, verify it works
4. Apply migration to Production Supabase
5. Deploy code to production

⚠️ **Never apply untested migrations to Production!**
